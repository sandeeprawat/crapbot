<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ agent_name }} â€” Web UI</title>
  <style>
    :root {
      --bg: #0d1117; --bg2: #161b22; --bg3: #21262d;
      --fg: #c9d1d9; --fg2: #8b949e; --accent: #58a6ff;
      --green: #3fb950; --red: #f85149; --yellow: #d29922;
      --border: #30363d; --radius: 8px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
           background: var(--bg); color: var(--fg); display: flex; flex-direction: column; height: 100vh; }
    header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 10px 20px;
             display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    header h1 { font-size: 1.15rem; color: var(--accent); }
    header .controls { display: flex; gap: 10px; align-items: center; font-size: .85rem; }
    header select, header button { background: var(--bg3); color: var(--fg); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 5px 10px; font-size: .85rem; cursor: pointer; }
    header button:hover { border-color: var(--accent); }
    .main-area { display: flex; flex: 1; overflow: hidden; }

    /* Chat pane */
    .chat-pane { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; overflow-y: auto; padding: 16px; }
    .msg { margin-bottom: 14px; line-height: 1.55; }
    .msg.user { color: var(--accent); }
    .msg.bot { color: var(--fg); }
    .msg .label { font-weight: 600; margin-right: 6px; }
    .msg pre { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
               padding: 10px; margin-top: 6px; overflow-x: auto; white-space: pre-wrap; font-size: .85rem; }
    .input-bar { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--border); background: var(--bg2); }
    .input-bar select { width: 110px; }
    .input-bar input[type=text] { flex: 1; background: var(--bg); color: var(--fg); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 8px 12px; font-size: .95rem; outline: none; }
    .input-bar input[type=text]:focus { border-color: var(--accent); }
    .input-bar button { background: var(--accent); color: #000; font-weight: 600; border: none;
      border-radius: var(--radius); padding: 8px 18px; cursor: pointer; font-size: .9rem; }
    .input-bar button:hover { opacity: .9; }

    /* Side panel */
    .side-panel { width: 340px; border-left: 1px solid var(--border); background: var(--bg2);
                  display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
    .side-panel h2 { font-size: .95rem; padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .sessions-list { flex: 1; overflow-y: auto; padding: 8px; }
    .session-card { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
                    padding: 10px; margin-bottom: 8px; font-size: .82rem; }
    .session-card .s-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .session-card .s-type { font-weight: 600; color: var(--accent); text-transform: capitalize; }
    .session-card .s-status { padding: 2px 8px; border-radius: 10px; font-size: .75rem; }
    .s-status.running { background: var(--green); color: #000; }
    .s-status.stopped, .s-status.timed_out { background: var(--red); color: #fff; }
    .session-card .s-desc { color: var(--fg2); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .session-card .s-meta { color: var(--fg2); font-size: .75rem; }
    .session-card button { margin-top: 6px; background: var(--red); color: #fff; border: none;
      border-radius: var(--radius); padding: 4px 10px; cursor: pointer; font-size: .78rem; }
    .session-card button:hover { opacity: .85; }
    .session-card button:disabled { opacity: .4; cursor: default; }

    /* Session start form */
    .start-form { border-top: 1px solid var(--border); padding: 12px 14px; }
    .start-form h3 { font-size: .85rem; margin-bottom: 8px; color: var(--fg2); }
    .start-form label { display: block; font-size: .8rem; color: var(--fg2); margin-bottom: 2px; }
    .start-form input, .start-form select, .start-form textarea {
      width: 100%; background: var(--bg); color: var(--fg); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 6px 8px; font-size: .82rem; margin-bottom: 8px; outline: none; }
    .start-form textarea { resize: vertical; min-height: 50px; font-family: inherit; }
    .start-form button { width: 100%; background: var(--green); color: #000; font-weight: 600;
      border: none; border-radius: var(--radius); padding: 7px; cursor: pointer; font-size: .85rem; }
    .start-form button:hover { opacity: .9; }

    /* Modal for session output */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,.6); z-index: 100; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius);
      width: 700px; max-width: 95vw; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .modal-header h3 { font-size: .95rem; }
    .modal-header button { background: none; border: none; color: var(--fg2); font-size: 1.2rem; cursor: pointer; }
    .modal-body { flex: 1; overflow-y: auto; padding: 12px 16px; font-size: .82rem; white-space: pre-wrap;
      font-family: monospace; line-height: 1.5; }
    .no-sessions { color: var(--fg2); text-align: center; padding: 20px; font-size: .85rem; }
    .tools-badge { font-size: .78rem; padding: 2px 8px; border-radius: 10px; cursor: pointer; }
    .tools-badge.on { background: var(--green); color: #000; }
    .tools-badge.off { background: var(--bg3); color: var(--fg2); border: 1px solid var(--border); }

    /* Timeout presets */
    .timeout-row { display: flex; gap: 6px; align-items: center; margin-bottom: 8px; }
    .timeout-row input[type=number] { width: 70px; }
    .timeout-row select { width: auto; flex-shrink: 0; }
  </style>
</head>
<body>

<header>
  <h1>ðŸ¤– {{ agent_name }}</h1>
  <div class="controls">
    <label style="font-size:.8rem;color:var(--fg2)">Model:</label>
    <select id="modelSelect"></select>
    <span id="toolsBadge" class="tools-badge on" onclick="toggleTools()" title="Click to toggle tools">Tools ON</span>
    <button onclick="resetConversation()">Reset</button>
  </div>
</header>

<div class="main-area">
  <!-- Chat pane -->
  <div class="chat-pane">
    <div id="messages"></div>
    <div class="input-bar">
      <select id="cmdSelect" title="Command type">
        <option value="chat">Chat</option>
        <option value="do">Do (auto)</option>
        <option value="search">Search</option>
        <option value="research">Research</option>
      </select>
      <input type="text" id="userInput" placeholder="Type a messageâ€¦" autocomplete="off">
      <button id="sendBtn" onclick="send()">Send</button>
    </div>
  </div>

  <!-- Sessions side panel -->
  <div class="side-panel">
    <h2>Active Sessions</h2>
    <div id="sessionsList" class="sessions-list">
      <div class="no-sessions">No active sessions</div>
    </div>

    <div class="start-form">
      <h3>Start Session</h3>
      <label>Type</label>
      <select id="sessionType">
        <option value="autonomous">Autonomous Agent</option>
        <option value="research">Deep Research</option>
      </select>
      <label id="sessionPromptLabel">Prompt / Problem</label>
      <textarea id="sessionPrompt" placeholder="Optional custom promptâ€¦"></textarea>
      <label>Max Timeout</label>
      <div class="timeout-row">
        <input type="number" id="timeoutValue" value="1" min="0" step="0.5">
        <select id="timeoutUnit">
          <option value="hours" selected>Hours</option>
          <option value="days">Days</option>
        </select>
        <label style="font-size:.78rem;display:flex;align-items:center;gap:4px;margin:0">
          <input type="checkbox" id="timeoutUnlimited"> Unlimited
        </label>
      </div>
      <button onclick="startSession()">Start Session</button>
    </div>
  </div>
</div>

<!-- Output modal -->
<div id="outputModal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">Session Output</h3>
      <button onclick="closeModal()">&times;</button>
    </div>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<script>
const API = "";
const AGENT_NAME = "{{ agent_name }}";
let toolsOn = true;
let sessionPollTimer = null;
let modalPollTimer = null;
let viewingSessionId = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener("DOMContentLoaded", () => {
  loadModels();
  loadToolsStatus();
  pollSessions();
  sessionPollTimer = setInterval(pollSessions, 5000);
  document.getElementById("userInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
  });
  document.getElementById("timeoutUnlimited").addEventListener("change", e => {
    document.getElementById("timeoutValue").disabled = e.target.checked;
    document.getElementById("timeoutUnit").disabled = e.target.checked;
  });
});

// â”€â”€ Models â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadModels() {
  try {
    const r = await fetch(API + "/api/models");
    const d = await r.json();
    const sel = document.getElementById("modelSelect");
    sel.innerHTML = "";
    d.models.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m; opt.textContent = m;
      if (m === d.current) opt.selected = true;
      sel.appendChild(opt);
    });
    sel.addEventListener("change", () => switchModel(sel.value));
  } catch { /* ignore */ }
}

async function switchModel(m) {
  await fetch(API + "/api/model", { method: "POST",
    headers: {"Content-Type":"application/json"}, body: JSON.stringify({model:m}) });
}

// â”€â”€ Tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadToolsStatus() {
  try {
    const r = await fetch(API + "/api/tools");
    const d = await r.json();
    toolsOn = d.enabled;
    updateToolsBadge();
  } catch { /* ignore */ }
}

async function toggleTools() {
  toolsOn = !toolsOn;
  await fetch(API + "/api/tools", { method: "POST",
    headers: {"Content-Type":"application/json"}, body: JSON.stringify({enabled:toolsOn}) });
  updateToolsBadge();
}

function updateToolsBadge() {
  const badge = document.getElementById("toolsBadge");
  badge.textContent = toolsOn ? "Tools ON" : "Tools OFF";
  badge.className = "tools-badge " + (toolsOn ? "on" : "off");
}

async function resetConversation() {
  await fetch(API + "/api/reset", { method: "POST" });
  document.getElementById("messages").innerHTML = "";
  appendMsg("system", "Conversation reset.");
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMsg(role, text) {
  const div = document.createElement("div");
  div.className = "msg " + role;
  const label = role === "user" ? "You" : role === "system" ? "System" : AGENT_NAME;
  // Escape HTML to prevent XSS
  const escaped = text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  div.innerHTML = `<span class="label">[${label}]</span><pre>${escaped}</pre>`;
  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = 99999;
}

async function send() {
  const input = document.getElementById("userInput");
  const cmd = document.getElementById("cmdSelect").value;
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  appendMsg("user", text);
  const btn = document.getElementById("sendBtn");
  btn.disabled = true; btn.textContent = "â€¦";

  try {
    let endpoint, body;
    if (cmd === "chat") {
      endpoint = "/api/chat"; body = { message: text };
    } else if (cmd === "do") {
      endpoint = "/api/do"; body = { task: text };
    } else if (cmd === "search") {
      endpoint = "/api/search"; body = { query: text };
    } else if (cmd === "research") {
      // Research starts a session
      const timeout = getTimeoutSeconds();
      endpoint = "/api/research";
      body = { problem: text, timeout: timeout === null ? "unlimited" : String(timeout) };
    }

    const r = await fetch(API + endpoint, { method: "POST",
      headers: {"Content-Type":"application/json"}, body: JSON.stringify(body) });
    const d = await r.json();

    if (d.response) {
      appendMsg("bot", d.response);
    } else if (d.session_id) {
      appendMsg("bot", `Session started: ${d.session_id}\nCheck the Sessions panel for output.`);
      pollSessions();
    } else if (d.error) {
      appendMsg("system", "Error: " + d.error);
    }
  } catch (err) {
    appendMsg("system", "Request failed: " + err.message);
  } finally {
    btn.disabled = false; btn.textContent = "Send";
  }
}

// â”€â”€ Sessions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollSessions() {
  try {
    const r = await fetch(API + "/api/sessions");
    const d = await r.json();
    renderSessions(d.sessions);
  } catch { /* ignore */ }
}

function renderSessions(sessions) {
  const container = document.getElementById("sessionsList");
  if (!sessions.length) {
    container.innerHTML = '<div class="no-sessions">No active sessions</div>';
    return;
  }
  container.innerHTML = sessions.map(s => {
    const statusCls = s.status;
    const canStop = s.status === "running";
    const timeout = s.timeout_seconds
      ? (s.timeout_seconds >= 86400 ? (s.timeout_seconds/86400).toFixed(1)+"d" : (s.timeout_seconds/3600).toFixed(1)+"h")
      : "unlimited";
    // Escape description to prevent XSS
    const desc = s.description.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    return `<div class="session-card">
      <div class="s-header">
        <span class="s-type">${s.type}</span>
        <span class="s-status ${statusCls}">${s.status}</span>
      </div>
      <div class="s-desc" title="${desc}">${desc}</div>
      <div class="s-meta">Timeout: ${timeout} Â· Started: ${new Date(s.started_at).toLocaleTimeString()}</div>
      <button onclick="viewSession('${s.id}')" style="background:var(--accent);color:#000;margin-right:4px">View</button>
      <button onclick="stopSession('${s.id}')" ${canStop ? '' : 'disabled'}>Stop</button>
    </div>`;
  }).join("");
}

async function stopSession(id) {
  await fetch(API + `/api/sessions/${encodeURIComponent(id)}/stop`, { method: "POST" });
  pollSessions();
}

async function viewSession(id) {
  viewingSessionId = id;
  modalOutputOffset = 0;
  document.getElementById("modalBody").innerHTML = "";
  document.getElementById("outputModal").classList.add("active");
  document.getElementById("modalTitle").textContent = "Session: " + id;
  await refreshModalOutput();
  modalPollTimer = setInterval(refreshModalOutput, 3000);
}

let modalOutputOffset = 0;

async function refreshModalOutput() {
  if (!viewingSessionId) return;
  try {
    const r = await fetch(API + `/api/sessions/${encodeURIComponent(viewingSessionId)}/output?offset=${modalOutputOffset}`);
    const d = await r.json();
    if (d.lines && d.lines.length > 0) {
      const body = document.getElementById("modalBody");
      const newContent = d.lines.map(l => l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).join("\n");
      if (modalOutputOffset === 0) {
        body.innerHTML = newContent;
      } else {
        body.innerHTML += "\n" + newContent;
      }
      modalOutputOffset = d.offset;
      body.scrollTop = body.scrollHeight;
    } else if (modalOutputOffset === 0) {
      document.getElementById("modalBody").innerHTML = "<em>No output yetâ€¦</em>";
    }
  } catch { /* ignore */ }
}

function closeModal() {
  document.getElementById("outputModal").classList.remove("active");
  viewingSessionId = null;
  if (modalPollTimer) { clearInterval(modalPollTimer); modalPollTimer = null; }
}

// â”€â”€ Start session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTimeoutSeconds() {
  if (document.getElementById("timeoutUnlimited").checked) return null;
  const val = parseFloat(document.getElementById("timeoutValue").value) || 1;
  const unit = document.getElementById("timeoutUnit").value;
  return unit === "days" ? val * 86400 : val * 3600;
}

async function startSession() {
  const type = document.getElementById("sessionType").value;
  const prompt = document.getElementById("sessionPrompt").value.trim();
  const timeout = getTimeoutSeconds();
  const timeoutStr = timeout === null ? "unlimited" : String(timeout);

  let endpoint, body;
  if (type === "autonomous") {
    endpoint = "/api/autonomous/start";
    body = { prompt: prompt || undefined, timeout: timeoutStr };
  } else {
    if (!prompt) { alert("Please provide a research problem."); return; }
    endpoint = "/api/research";
    body = { problem: prompt, timeout: timeoutStr };
  }

  try {
    const r = await fetch(API + endpoint, { method: "POST",
      headers: {"Content-Type":"application/json"}, body: JSON.stringify(body) });
    const d = await r.json();
    appendMsg("bot", `Session started: ${d.session_id}\nTimeout: ${d.timeout_seconds ? (d.timeout_seconds/3600).toFixed(1)+"h" : "unlimited"}`);
    pollSessions();
  } catch (err) {
    alert("Failed to start session: " + err.message);
  }
}
</script>
</body>
</html>
